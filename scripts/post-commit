#!/bin/bash

# Post-commit hook to generate pronunciations and definitions when words.json is modified

# Get the list of files changed in the last commit
changed_files=$(git diff-tree --no-commit-id --name-only -r HEAD)

# Check if words.json was modified
if echo "$changed_files" | grep -q "public/data/words.json"; then
    echo "üîÑ words.json was modified, running post-commit scripts..."

    # Change to the repository root directory
    cd "$(git rev-parse --show-toplevel)"

    # Generate pronunciations for new/changed words
    echo "üîä Generating pronunciations for new/changed words..."
    if [ -z "$OPENAI_API_KEY" ] && [ ! -f ".env.local" ]; then
        echo "‚ö†Ô∏è  OPENAI_API_KEY not found. Skipping pronunciation generation."
        echo "   Add OPENAI_API_KEY to your .env.local file to enable automatic pronunciation generation."
    else
        if npx tsx scripts/generate-pronunciations.ts; then
            echo "‚úÖ Pronunciations generated successfully"

            # Check if words.json or pronunciation files were updated
            if ! git diff --quiet public/data/words.json public/pronunciations/; then
                echo "üìù Staging updated pronunciation files..."
                git add public/data/words.json public/pronunciations/
            fi
        else
            echo "‚ö†Ô∏è  Failed to generate pronunciations (continuing anyway)"
        fi
    fi

    # Generate definitions for new words
    echo "üìñ Generating definitions for new words..."
    if [ -z "$BRAINTRUST_API_KEY" ] && [ ! -f ".env.local" ]; then
        echo "‚ö†Ô∏è  BRAINTRUST_API_KEY not found. Skipping definition generation."
        echo "   Add BRAINTRUST_API_KEY to your .env.local file to enable automatic definition generation."
    else
        if npx tsx scripts/generate-definitions.ts; then
            echo "‚úÖ Definitions generated successfully"

            # Check if words.json was updated
            if ! git diff --quiet public/data/words.json; then
                echo "üìù Staging updated definitions..."
                git add public/data/words.json
            fi
        else
            echo "‚ö†Ô∏è  Failed to generate definitions (continuing anyway)"
        fi
    fi

    # Generate embeddings for words with changed semantic fields
    echo "ü§ñ Generating embeddings for words.json..."
    if [ -z "$OPENAI_API_KEY" ] && [ ! -f ".env.local" ]; then
        echo "‚ö†Ô∏è  OPENAI_API_KEY not found. Skipping embedding generation."
        echo "   Add OPENAI_API_KEY to your .env.local file to enable automatic embedding generation."
    else
        if npx tsx scripts/generate-embeddings.ts; then
            echo "‚úÖ Embeddings generated successfully"

            # Check if words-with-embeddings.json was updated
            if ! git diff --quiet public/data/words-with-embeddings.json; then
                echo "üìù Staging updated embeddings..."
                git add public/data/words-with-embeddings.json
            fi
        else
            echo "‚ö†Ô∏è  Failed to generate embeddings (continuing anyway)"
        fi
    fi

    echo "‚ú® Post-commit processing complete"

    # Check if there are any staged files to commit
    if ! git diff --cached --quiet; then
        echo ""
        echo "üìù Generated files have been staged. Please commit them:"
        echo "   git commit -m 'chore: update embeddings, pronunciations, and definitions'"
    fi
else
    echo "üìÑ words.json was not modified, skipping post-commit scripts"
fi
